<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>3001-dirtree</title>

  <link rel="stylesheet" href="filesystem/bower_components/webix/codebase/skins/compact.css" type="text/css">
  <script src="filesystem/bower_components/webix/codebase/webix.js"></script>
</head>

<body>
  <script>
    var token = ""

    webix.ajax().get("/filesystem/user", function (t, d, x) {
      token = d.json().token
    })

    function formatBytes(a, b) {
      if (0 == a) return "0 Bytes";
      var c = 1024, d = b || 2,
        e = ["Bytes", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"],
        f = Math.floor(Math.log(a) / Math.log(c));
      return parseFloat((a / Math.pow(c, f)).toFixed(d)) + " " + e[f]
    }

    function parseTree(obj, level = 0) {
      if (obj.children) {
        obj.data = obj.children
        delete obj.children
        obj.data.forEach(function (item) { item = parseTree(item, level + 1) })
        return obj
      }
    }

    webix.ready(function () {
      webix.ui({
        rows: [
          { view: "toolbar", elements: [{ view: "label", width: 450, label: "Usage: GET /dirtree?path=&lt path &gt" }] },
          {
            view: "form", elements: [
              {
                id: "pathInput", view: "text", label: "Path", name: "path", placeholder: "Enter full path to expand here..", on: {
                  "onChange": function (newv, oldv) {
                    $$("directoryTree").clearAll()
                    webix.ajax().headers({ "Authorization": "Bearer " + token }).get("/filesystem/dirtree?path=" + newv, function (t, d, x) {
                      items = d.json()
                      $$("directoryTree").parse(parseTree(items));
                      $$("directoryTree").serialize().forEach(function(item){$$("directoryTree").open(item.id)})
                    })
                  }
                }
              },
            ]
          },
          {
            id: "directoryTree",
            view: "treetable",
            columns: [
              { id: "name", header: "Path", fillspace: 1, template: "{common.treetable()} #name#" },
              { id: "size", header: "Size", width: 125, template: function (obj) { return formatBytes(obj.size); } },
            ],
            data: [{ name: "Path", open: true, children: [{ name: "Sub-Path" }] }],
            select: true,
          }
        ]
      });
    })
  </script>
</body>

</html>
